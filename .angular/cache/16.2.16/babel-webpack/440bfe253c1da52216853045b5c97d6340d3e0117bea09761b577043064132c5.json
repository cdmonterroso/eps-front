{"ast":null,"code":"import _asyncToGenerator from \"D:/Users/Daniel/Documents/EPS/Proyecto/front/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { inject } from '@angular/core';\nimport { Router } from '@angular/router';\nimport { KeycloakService } from 'keycloak-angular';\n/*export const keycloakGuard: CanActivateFn = (route, state) => {\n  return true;\n};*/\n/*@Injectable({\n  providedIn: 'root'\n})\nexport class KeycloakGuard implements CanActivate {\n\n  constructor(private keycloakService: KeycloakService) { }\n\n  canActivate(\n    next: ActivatedRouteSnapshot,\n    state: RouterStateSnapshot\n  ): Observable<boolean | UrlTree> | Promise<boolean | UrlTree> | boolean | UrlTree {\n    return this.keycloakService.isLoggedIn();\n  }\n}*/\nexport const keycloakGuard = (next, state) => {\n  const keycloakService = inject(KeycloakService);\n  return keycloakService.isLoggedIn();\n};\nexport const authGuard = /*#__PURE__*/function () {\n  var _ref = _asyncToGenerator(function* (route, state) {\n    // Inyectamos el servicio Keycloak y el Router.\n    const keycloak = inject(KeycloakService);\n    const router = inject(Router);\n    // Verificamos si el usuario está autenticado.\n    const authenticated = yield keycloak.isLoggedIn();\n    console.log('isLoggedIn(): ', authenticated);\n    if (!authenticated) {\n      // Redirigimos al usuario al login de Keycloak si no está autenticado.\n      /*await keycloak.login({\n        redirectUri: window.location.origin + state.url,\n      });*/\n      console.log('El usuario no está autenticado (keycloak.login)');\n      return false; // Previene el acceso mientras se realiza el inicio de sesión.\n    }\n    // Obtenemos los roles requeridos desde la configuración de la ruta.\n    const requiredRoles = route.data['roles'];\n    // Si no se especifican roles, permitimos el acceso.\n    if (!Array.isArray(requiredRoles) || requiredRoles.length === 0) {\n      console.log('Roles del usuario: ', requiredRoles);\n      console.log('No se especificaron roles y se dio acceso al usuario');\n      return true;\n    }\n    // Obtenemos los roles asignados al usuario.\n    const userRoles = (yield keycloak.getUserRoles()) || [];\n    // Permitimos el acceso solo si el usuario tiene todos los roles requeridos.\n    const hasAllRoles = requiredRoles.every(role => userRoles.includes(role));\n    if (!hasAllRoles) {\n      // Redirigimos al usuario si no tiene los roles requeridos.\n      router.navigate(['/unauthorized']);\n      return false;\n    }\n    return true; // El usuario tiene acceso permitido.\n  });\n  return function authGuard(_x, _x2) {\n    return _ref.apply(this, arguments);\n  };\n}();","map":{"version":3,"names":["inject","Router","KeycloakService","keycloakGuard","next","state","keycloakService","isLoggedIn","authGuard","_ref","_asyncToGenerator","route","keycloak","router","authenticated","console","log","requiredRoles","data","Array","isArray","length","userRoles","getUserRoles","hasAllRoles","every","role","includes","navigate","_x","_x2","apply","arguments"],"sources":["D:\\Users\\Daniel\\Documents\\EPS\\Proyecto\\front\\src\\app\\guards\\keycloak.guard.ts"],"sourcesContent":["import { inject } from '@angular/core';\nimport { CanActivateFn, ActivatedRouteSnapshot, Router, RouterStateSnapshot, UrlTree } from '@angular/router';\nimport { KeycloakService, KeycloakAuthGuard } from 'keycloak-angular';\nimport { Observable } from 'rxjs';\n\n/*export const keycloakGuard: CanActivateFn = (route, state) => {\n  return true;\n};*/\n\n/*@Injectable({\n  providedIn: 'root'\n})\nexport class KeycloakGuard implements CanActivate {\n\n  constructor(private keycloakService: KeycloakService) { }\n\n  canActivate(\n    next: ActivatedRouteSnapshot,\n    state: RouterStateSnapshot\n  ): Observable<boolean | UrlTree> | Promise<boolean | UrlTree> | boolean | UrlTree {\n    return this.keycloakService.isLoggedIn();\n  }\n}*/\n\nexport const keycloakGuard: CanActivateFn = (\n  next: ActivatedRouteSnapshot,\n  state: RouterStateSnapshot\n) => {\n  const keycloakService = inject(KeycloakService);\n  return keycloakService.isLoggedIn();\n};\n\n\nexport const authGuard: CanActivateFn = async (route: ActivatedRouteSnapshot, state: RouterStateSnapshot) => {\n  // Inyectamos el servicio Keycloak y el Router.\n  const keycloak = inject(KeycloakService);\n  const router = inject(Router);\n\n  // Verificamos si el usuario está autenticado.\n  const authenticated = await keycloak.isLoggedIn();\n  console.log('isLoggedIn(): ', authenticated);\n  if (!authenticated) {\n    // Redirigimos al usuario al login de Keycloak si no está autenticado.\n    /*await keycloak.login({\n      redirectUri: window.location.origin + state.url,\n    });*/\n    console.log('El usuario no está autenticado (keycloak.login)');\n    return false; // Previene el acceso mientras se realiza el inicio de sesión.\n  }\n\n  // Obtenemos los roles requeridos desde la configuración de la ruta.\n  const requiredRoles: string[] = route.data['roles'];\n\n  // Si no se especifican roles, permitimos el acceso.\n  if (!Array.isArray(requiredRoles) || requiredRoles.length === 0) {\n    console.log('Roles del usuario: ', requiredRoles);\n    console.log('No se especificaron roles y se dio acceso al usuario');\n    return true;\n  }\n\n  // Obtenemos los roles asignados al usuario.\n  const userRoles = (await keycloak.getUserRoles()) || [];\n\n  // Permitimos el acceso solo si el usuario tiene todos los roles requeridos.\n  const hasAllRoles = requiredRoles.every(role => userRoles.includes(role));\n\n  if (!hasAllRoles) {\n    // Redirigimos al usuario si no tiene los roles requeridos.\n    router.navigate(['/unauthorized']);\n    return false;\n  }\n\n  return true; // El usuario tiene acceso permitido.\n};"],"mappings":";AAAA,SAASA,MAAM,QAAQ,eAAe;AACtC,SAAgDC,MAAM,QAAsC,iBAAiB;AAC7G,SAASC,eAAe,QAA2B,kBAAkB;AAGrE;;;AAIA;;;;;;;;;;;;;;AAeA,OAAO,MAAMC,aAAa,GAAkBA,CAC1CC,IAA4B,EAC5BC,KAA0B,KACxB;EACF,MAAMC,eAAe,GAAGN,MAAM,CAACE,eAAe,CAAC;EAC/C,OAAOI,eAAe,CAACC,UAAU,EAAE;AACrC,CAAC;AAGD,OAAO,MAAMC,SAAS;EAAA,IAAAC,IAAA,GAAAC,iBAAA,CAAkB,WAAOC,KAA6B,EAAEN,KAA0B,EAAI;IAC1G;IACA,MAAMO,QAAQ,GAAGZ,MAAM,CAACE,eAAe,CAAC;IACxC,MAAMW,MAAM,GAAGb,MAAM,CAACC,MAAM,CAAC;IAE7B;IACA,MAAMa,aAAa,SAASF,QAAQ,CAACL,UAAU,EAAE;IACjDQ,OAAO,CAACC,GAAG,CAAC,gBAAgB,EAAEF,aAAa,CAAC;IAC5C,IAAI,CAACA,aAAa,EAAE;MAClB;MACA;;;MAGAC,OAAO,CAACC,GAAG,CAAC,iDAAiD,CAAC;MAC9D,OAAO,KAAK,CAAC,CAAC;;IAGhB;IACA,MAAMC,aAAa,GAAaN,KAAK,CAACO,IAAI,CAAC,OAAO,CAAC;IAEnD;IACA,IAAI,CAACC,KAAK,CAACC,OAAO,CAACH,aAAa,CAAC,IAAIA,aAAa,CAACI,MAAM,KAAK,CAAC,EAAE;MAC/DN,OAAO,CAACC,GAAG,CAAC,qBAAqB,EAAEC,aAAa,CAAC;MACjDF,OAAO,CAACC,GAAG,CAAC,sDAAsD,CAAC;MACnE,OAAO,IAAI;;IAGb;IACA,MAAMM,SAAS,GAAG,OAAOV,QAAQ,CAACW,YAAY,EAAE,KAAK,EAAE;IAEvD;IACA,MAAMC,WAAW,GAAGP,aAAa,CAACQ,KAAK,CAACC,IAAI,IAAIJ,SAAS,CAACK,QAAQ,CAACD,IAAI,CAAC,CAAC;IAEzE,IAAI,CAACF,WAAW,EAAE;MAChB;MACAX,MAAM,CAACe,QAAQ,CAAC,CAAC,eAAe,CAAC,CAAC;MAClC,OAAO,KAAK;;IAGd,OAAO,IAAI,CAAC,CAAC;EACf,CAAC;EAAA,gBAxCYpB,SAASA,CAAAqB,EAAA,EAAAC,GAAA;IAAA,OAAArB,IAAA,CAAAsB,KAAA,OAAAC,SAAA;EAAA;AAAA,GAwCrB","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}