{"ast":null,"code":"import _asyncToGenerator from \"D:/Users/Daniel/Documents/EPS/Proyecto/front/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { inject } from '@angular/core';\nimport { Router } from '@angular/router';\nimport { KeycloakService } from 'keycloak-angular';\nimport { KeycloakAppService } from \"../services/keycloak.service\";\n/*export const keycloakGuard: CanActivateFn = (route, state) => {\n  return true;\n};*/\n/*@Injectable({\n  providedIn: 'root'\n})\nexport class KeycloakGuard implements CanActivate {\n\n  constructor(private keycloakService: KeycloakService) { }\n\n  canActivate(\n    next: ActivatedRouteSnapshot,\n    state: RouterStateSnapshot\n  ): Observable<boolean | UrlTree> | Promise<boolean | UrlTree> | boolean | UrlTree {\n    return this.keycloakService.isLoggedIn();\n  }\n}*/\n/*export const keycloakGuard: CanActivateFn = (\n  next: ActivatedRouteSnapshot,\n  state: RouterStateSnapshot\n) => {\n  const keycloakService = inject(KeycloakService);\n  return keycloakService.isLoggedIn();\n};*/\nexport const authGuard = /*#__PURE__*/function () {\n  var _ref = _asyncToGenerator(function* (route, state) {\n    // Inyectamos el servicio Keycloak y el Router.\n    const keycloak = inject(KeycloakService);\n    const router = inject(Router);\n    // Verificamos si el usuario está autenticado.\n    const authenticated = yield keycloak.isLoggedIn();\n    console.log('isLoggedIn(): ', authenticated);\n    if (!authenticated) {\n      // Redirigimos al usuario al login de Keycloak si no está autenticado.\n      /*await keycloak.login({\n        redirectUri: window.location.origin + state.url,\n      });*/\n      console.log('El usuario no está autenticado (keycloak.login)');\n      return false; // Previene el acceso mientras se realiza el inicio de sesión.\n    }\n    // Obtenemos los roles requeridos desde la configuración de la ruta.\n    const requiredRoles = route.data['roles'];\n    // Si no se especifican roles, permitimos el acceso.\n    if (!Array.isArray(requiredRoles) || requiredRoles.length === 0) {\n      console.log('Roles del usuario: ', requiredRoles);\n      console.log('No se especificaron roles y se dio acceso al usuario');\n      return true;\n    }\n    // Obtenemos los roles asignados al usuario.\n    const userRoles = (yield keycloak.getUserRoles()) || [];\n    // Permitimos el acceso solo si el usuario tiene todos los roles requeridos.\n    const hasAllRoles = requiredRoles.every(role => userRoles.includes(role));\n    if (!hasAllRoles) {\n      // Redirigimos al usuario si no tiene los roles requeridos.\n      router.navigate(['/unauthorized']);\n      return false;\n    }\n    return true; // El usuario tiene acceso permitido.\n  });\n  return function authGuard(_x, _x2) {\n    return _ref.apply(this, arguments);\n  };\n}();\nexport const AuthGuard = /*#__PURE__*/function () {\n  var _ref2 = _asyncToGenerator(function* () {\n    const authenticationService = inject(KeycloakAppService);\n    if (yield authenticationService.isLoggedIn()) {\n      return true;\n    }\n    authenticationService.redirectToLoginPage();\n    return false;\n  });\n  return function AuthGuard() {\n    return _ref2.apply(this, arguments);\n  };\n}();\nexport const LogoutRouteGuard = () => {\n  const authenticationService = inject(KeycloakAppService);\n  const router = inject(Router);\n  if (!authenticationService.isLoggedIn()) {\n    return true;\n  } else {\n    return router.createUrlTree(['']); //Ruta vacía\n  }\n};","map":{"version":3,"names":["inject","Router","KeycloakService","KeycloakAppService","authGuard","_ref","_asyncToGenerator","route","state","keycloak","router","authenticated","isLoggedIn","console","log","requiredRoles","data","Array","isArray","length","userRoles","getUserRoles","hasAllRoles","every","role","includes","navigate","_x","_x2","apply","arguments","AuthGuard","_ref2","authenticationService","redirectToLoginPage","LogoutRouteGuard","createUrlTree"],"sources":["D:\\Users\\Daniel\\Documents\\EPS\\Proyecto\\front\\src\\app\\guards\\keycloak.guard.ts"],"sourcesContent":["import { inject } from '@angular/core';\nimport { CanActivateFn, ActivatedRouteSnapshot, Router, RouterStateSnapshot, UrlTree } from '@angular/router';\nimport { KeycloakService, KeycloakAuthGuard } from 'keycloak-angular';\nimport { KeycloakAppService } from \"../services/keycloak.service\";\nimport { Observable } from 'rxjs';\n\n/*export const keycloakGuard: CanActivateFn = (route, state) => {\n  return true;\n};*/\n\n/*@Injectable({\n  providedIn: 'root'\n})\nexport class KeycloakGuard implements CanActivate {\n\n  constructor(private keycloakService: KeycloakService) { }\n\n  canActivate(\n    next: ActivatedRouteSnapshot,\n    state: RouterStateSnapshot\n  ): Observable<boolean | UrlTree> | Promise<boolean | UrlTree> | boolean | UrlTree {\n    return this.keycloakService.isLoggedIn();\n  }\n}*/\n\n\n\n\n/*export const keycloakGuard: CanActivateFn = (\n  next: ActivatedRouteSnapshot,\n  state: RouterStateSnapshot\n) => {\n  const keycloakService = inject(KeycloakService);\n  return keycloakService.isLoggedIn();\n};*/\n\n\nexport const authGuard: CanActivateFn = async (route: ActivatedRouteSnapshot, state: RouterStateSnapshot) => {\n  // Inyectamos el servicio Keycloak y el Router.\n  const keycloak = inject(KeycloakService);\n  const router = inject(Router);\n\n  // Verificamos si el usuario está autenticado.\n  const authenticated = await keycloak.isLoggedIn();\n  console.log('isLoggedIn(): ', authenticated);\n  if (!authenticated) {\n    // Redirigimos al usuario al login de Keycloak si no está autenticado.\n    /*await keycloak.login({\n      redirectUri: window.location.origin + state.url,\n    });*/\n    console.log('El usuario no está autenticado (keycloak.login)');\n    return false; // Previene el acceso mientras se realiza el inicio de sesión.\n  }\n\n  // Obtenemos los roles requeridos desde la configuración de la ruta.\n  const requiredRoles: string[] = route.data['roles'];\n\n  // Si no se especifican roles, permitimos el acceso.\n  if (!Array.isArray(requiredRoles) || requiredRoles.length === 0) {\n    console.log('Roles del usuario: ', requiredRoles);\n    console.log('No se especificaron roles y se dio acceso al usuario');\n    return true;\n  }\n\n  // Obtenemos los roles asignados al usuario.\n  const userRoles = (await keycloak.getUserRoles()) || [];\n\n  // Permitimos el acceso solo si el usuario tiene todos los roles requeridos.\n  const hasAllRoles = requiredRoles.every(role => userRoles.includes(role));\n\n  if (!hasAllRoles) {\n    // Redirigimos al usuario si no tiene los roles requeridos.\n    router.navigate(['/unauthorized']);\n    return false;\n  }\n  return true; // El usuario tiene acceso permitido.\n};\n\n\nexport const AuthGuard: CanActivateFn = async (): Promise <boolean> => {\n  const authenticationService = inject(KeycloakAppService);\n  if (await authenticationService.isLoggedIn()) {\n    return true;\n  }\n  authenticationService.redirectToLoginPage();\n  return false;\n};\n\n\nexport const LogoutRouteGuard: CanActivateFn = () => {\n  const authenticationService = inject(KeycloakAppService);\n  const router = inject(Router);\n  if (!authenticationService.isLoggedIn()) {\n    return true;\n  } else {\n    return router.createUrlTree(['']); //Ruta vacía\n  }\n};"],"mappings":";AAAA,SAASA,MAAM,QAAQ,eAAe;AACtC,SAAgDC,MAAM,QAAsC,iBAAiB;AAC7G,SAASC,eAAe,QAA2B,kBAAkB;AACrE,SAASC,kBAAkB,QAAQ,8BAA8B;AAGjE;;;AAIA;;;;;;;;;;;;;;AAkBA;;;;;;;AASA,OAAO,MAAMC,SAAS;EAAA,IAAAC,IAAA,GAAAC,iBAAA,CAAkB,WAAOC,KAA6B,EAAEC,KAA0B,EAAI;IAC1G;IACA,MAAMC,QAAQ,GAAGT,MAAM,CAACE,eAAe,CAAC;IACxC,MAAMQ,MAAM,GAAGV,MAAM,CAACC,MAAM,CAAC;IAE7B;IACA,MAAMU,aAAa,SAASF,QAAQ,CAACG,UAAU,EAAE;IACjDC,OAAO,CAACC,GAAG,CAAC,gBAAgB,EAAEH,aAAa,CAAC;IAC5C,IAAI,CAACA,aAAa,EAAE;MAClB;MACA;;;MAGAE,OAAO,CAACC,GAAG,CAAC,iDAAiD,CAAC;MAC9D,OAAO,KAAK,CAAC,CAAC;;IAGhB;IACA,MAAMC,aAAa,GAAaR,KAAK,CAACS,IAAI,CAAC,OAAO,CAAC;IAEnD;IACA,IAAI,CAACC,KAAK,CAACC,OAAO,CAACH,aAAa,CAAC,IAAIA,aAAa,CAACI,MAAM,KAAK,CAAC,EAAE;MAC/DN,OAAO,CAACC,GAAG,CAAC,qBAAqB,EAAEC,aAAa,CAAC;MACjDF,OAAO,CAACC,GAAG,CAAC,sDAAsD,CAAC;MACnE,OAAO,IAAI;;IAGb;IACA,MAAMM,SAAS,GAAG,OAAOX,QAAQ,CAACY,YAAY,EAAE,KAAK,EAAE;IAEvD;IACA,MAAMC,WAAW,GAAGP,aAAa,CAACQ,KAAK,CAACC,IAAI,IAAIJ,SAAS,CAACK,QAAQ,CAACD,IAAI,CAAC,CAAC;IAEzE,IAAI,CAACF,WAAW,EAAE;MAChB;MACAZ,MAAM,CAACgB,QAAQ,CAAC,CAAC,eAAe,CAAC,CAAC;MAClC,OAAO,KAAK;;IAEd,OAAO,IAAI,CAAC,CAAC;EACf,CAAC;EAAA,gBAvCYtB,SAASA,CAAAuB,EAAA,EAAAC,GAAA;IAAA,OAAAvB,IAAA,CAAAwB,KAAA,OAAAC,SAAA;EAAA;AAAA,GAuCrB;AAGD,OAAO,MAAMC,SAAS;EAAA,IAAAC,KAAA,GAAA1B,iBAAA,CAAkB,aAA8B;IACpE,MAAM2B,qBAAqB,GAAGjC,MAAM,CAACG,kBAAkB,CAAC;IACxD,UAAU8B,qBAAqB,CAACrB,UAAU,EAAE,EAAE;MAC5C,OAAO,IAAI;;IAEbqB,qBAAqB,CAACC,mBAAmB,EAAE;IAC3C,OAAO,KAAK;EACd,CAAC;EAAA,gBAPYH,SAASA,CAAA;IAAA,OAAAC,KAAA,CAAAH,KAAA,OAAAC,SAAA;EAAA;AAAA,GAOrB;AAGD,OAAO,MAAMK,gBAAgB,GAAkBA,CAAA,KAAK;EAClD,MAAMF,qBAAqB,GAAGjC,MAAM,CAACG,kBAAkB,CAAC;EACxD,MAAMO,MAAM,GAAGV,MAAM,CAACC,MAAM,CAAC;EAC7B,IAAI,CAACgC,qBAAqB,CAACrB,UAAU,EAAE,EAAE;IACvC,OAAO,IAAI;GACZ,MAAM;IACL,OAAOF,MAAM,CAAC0B,aAAa,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC;;AAEvC,CAAC","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}